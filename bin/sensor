#!/usr/bin/python
import os
import time
import sqlite3
from datetime import datetime

import Adafruit_DHT

DB_FILE = '/config/sensor.db'
DHT_TYPE = getattr(Adafruit_DHT, os.getenv('SENSOR_TYPE'))
DHT_PIN = os.getenv('SENSOR_PIN')

while not os.access(DB_FILE, os.W_OK):
  print('{} - db not initialized'.format(datetime.now()))
  time.sleep(60)

conn = sqlite3.connect(DB_FILE)
c = conn.cursor()
c.execute('PRAGMA journal_mode = WAL')

while True:
  humidity, temperature = Adafruit_DHT.read_retry(DHT_TYPE, DHT_PIN)

  if humidity is not None and temperature is not None:
    c.execute('INSERT INTO `readings` (`temperature`, `humidity`) VALUES (?, ?)', (temperature, humidity))
    conn.commit()
    time.sleep(20)
  else:
    print('{} - Unable to read sensor'.format(datetime.now()))
    time.sleep(5)
